generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Conversation {
  id          String   @id @default(cuid())
  title       String
  model       String
  provider    String
  projectId   String?  // Optional link to hydraulic project
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  messages    Message[]
  project     HydraulicProject? @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@map("conversations")
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  role           String   // 'user' | 'assistant' | 'system'
  content        String
  timestamp      DateTime @default(now())
  metadata       String?  // JSON as string for additional data
  createdAt      DateTime @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model AIProvider {
  id               String   @id @default(cuid())
  name             String   @unique
  type             String   // 'local' | 'api'
  apiKey           String?  // Encrypted API key
  isActive         Boolean  @default(false) // Changed to default false
  isConnected      Boolean  @default(false)
  lastTestResult   String?  // 'success' | 'error' | null
  lastTestMessage  String?  // Error message or success details
  config           String?  // Additional configuration as JSON string
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  models           AIModel[]

  @@map("ai_providers")
}

model AIModel {
  id          String   @id @default(cuid())
  providerId  String
  modelName   String
  modelId     String
  isDefault   Boolean  @default(false)
  isAvailable Boolean  @default(true)
  isSelected  Boolean  @default(false) // New field for user selection
  description String?  // Model description
  metadata    String?  // Model-specific metadata as JSON string
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  provider    AIProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, modelId])
  @@map("ai_models")
}

model AppSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  category  String?  // 'general', 'ai', 'theme', etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("app_settings")
}

model Document {
  id          String   @id @default(cuid())
  filename    String
  filepath    String
  content     String
  metadata    String?  // JSON as string
  embeddings  String?  // JSON as string
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  chunks DocumentChunk[]

  @@map("documents")
}

model DocumentChunk {
  id         String   @id @default(cuid())
  documentId String
  content    String
  embedding  String?  // JSON as string
  metadata   String?  // JSON as string
  startPos   Int?
  endPos     Int?
  createdAt  DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@map("document_chunks")
}

model AuthToken {
  id          String   @id @default(cuid())
  provider    String
  tokenType   String
  accessToken String
  refreshToken String?
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([provider, tokenType])
  @@map("auth_tokens")
}

model EmailMessage {
  id          String   @id @default(cuid())
  provider    String
  messageId   String
  subject     String
  from        String
  to          String   // JSON as string
  cc          String?  // JSON as string
  bcc         String?  // JSON as string
  body        String
  htmlBody    String?
  attachments String?  // JSON as string
  isRead      Boolean  @default(false)
  isImportant Boolean  @default(false)
  receivedAt  DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([provider, messageId])
  @@map("email_messages")
}

model CalendarEvent {
  id          String   @id @default(cuid())
  provider    String
  eventId     String
  title       String
  description String?
  location    String?
  startTime   DateTime
  endTime     DateTime
  isAllDay    Boolean  @default(false)
  attendees   String?  // JSON as string
  organizer   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([provider, eventId])
  @@map("calendar_events")
}

model UserProfile {
  id          String   @id @default(cuid())
  provider    String   // 'microsoft' | 'google'
  providerId  String   // User ID from provider
  email       String
  name        String?
  pictureUrl  String?
  isActive    Boolean  @default(true)
  metadata    String?  // Additional profile data as JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([provider, providerId])
  @@map("user_profiles")
}

// Hydraulic Engineering Models
model HydraulicProject {
  id            String   @id @default(cuid())
  name          String
  description   String?
  type          String   // 'design' | 'analysis' | 'optimization' | 'troubleshooting'
  networkType   String   // 'distribution' | 'transmission' | 'collection'
  location      String   // JSON with country, region, city, coordinates
  status        String   // 'planning' | 'design' | 'review' | 'approved' | 'construction' | 'completed'
  regulations   String   // JSON array of regulation IDs
  wntrModel     String?  // JSON serialized WNTR model
  metadata      String?  // Additional project metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  calculations  HydraulicCalculation[]
  documents     ProjectDocument[]
  teamMembers   ProjectTeamMember[]
  conversations Conversation[]

  @@map("hydraulic_projects")
}

model HydraulicCalculation {
  id          String   @id @default(cuid())
  projectId   String
  type        String   // 'pipe_sizing' | 'pump_selection' | 'head_loss' | 'water_hammer' | etc
  name        String
  inputs      String   // JSON with calculation inputs
  results     String   // JSON with calculation results
  formulas    String   // JSON array of formulas used
  verified    Boolean  @default(false)
  verifiedBy  String?
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     HydraulicProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("hydraulic_calculations")
}

model ProjectDocument {
  id          String   @id @default(cuid())
  projectId   String
  type        String   // 'calculation_memory' | 'technical_spec' | 'report' | 'plan' | 'compliance'
  title       String
  content     String   // Document content (could be markdown, HTML, etc)
  metadata    String   // JSON with author, version, status, etc
  attachments String?  // JSON array of attachment info
  version     String   @default("1.0")
  status      String   @default("draft") // 'draft' | 'review' | 'approved'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  project     HydraulicProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("project_documents")
}

model ProjectTeamMember {
  id          String   @id @default(cuid())
  projectId   String
  userId      String   // Reference to user (could be email or ID)
  role        String   // 'project_manager' | 'design_engineer' | 'reviewer' | 'client'
  permissions String   // JSON with specific permissions
  joinedAt    DateTime @default(now())

  project     HydraulicProject @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_team_members")
}

// RAG Knowledge Base Models
model HydraulicKnowledge {
  id          String   @id @default(cuid())
  category    String   // 'hydraulics' | 'regulations' | 'best-practices'
  subcategory String
  region      String   // JSON array of applicable regions
  title       String
  content     String   // Main content of the document
  metadata    String   // JSON with formulas, tables, examples, references
  keywords    String   // JSON array for search optimization
  language    String   @default("es")
  version     String   @default("1.0")
  status      String   @default("active") // 'draft' | 'active' | 'deprecated'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  chunks      KnowledgeChunk[]

  @@map("hydraulic_knowledge")
}

model KnowledgeChunk {
  id            String   @id @default(cuid())
  knowledgeId   String
  content       String
  embedding     String   // Vector embedding as JSON array
  metadata      String?  // Additional chunk metadata
  chunkIndex    Int      // Order of chunk in document
  createdAt     DateTime @default(now())

  knowledge     HydraulicKnowledge @relation(fields: [knowledgeId], references: [id], onDelete: Cascade)

  @@map("knowledge_chunks")
}

// Hydraulic Components Catalog
model HydraulicComponent {
  id              String   @id @default(cuid())
  type            String   // 'pipe' | 'pump' | 'valve' | 'tank' | 'fitting'
  manufacturer    String?
  model           String?
  specifications  String   // JSON with technical specs
  priceInfo       String?  // JSON with pricing data
  availability    String?  // JSON with availability info
  documentation   String?  // Links to technical docs
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("hydraulic_components")
}