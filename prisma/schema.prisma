generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "windows", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Conversation {
  id                     String   @id @default(cuid())
  title                  String
  model                  String
  provider               String
  selectedCollectionIds  String?  // JSON array of collection IDs for RAG context
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  messages    Message[]

  @@map("conversations")
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  role           String   // 'user' | 'assistant' | 'system'
  content        String
  timestamp      DateTime @default(now())
  metadata       String?  // JSON as string for additional data
  createdAt      DateTime @default(now())

  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model AIProvider {
  id               String   @id @default(cuid())
  name             String   @unique
  type             String   // 'local' | 'api'
  apiKey           String?  // Encrypted API key
  isActive         Boolean  @default(false) // Changed to default false
  isConnected      Boolean  @default(false)
  lastTestResult   String?  // 'success' | 'error' | null
  lastTestMessage  String?  // Error message or success details
  config           String?  // Additional configuration as JSON string
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  models           AIModel[]

  @@map("ai_providers")
}

model AIModel {
  id          String   @id @default(cuid())
  providerId  String
  modelName   String
  modelId     String
  isDefault   Boolean  @default(false)
  isAvailable Boolean  @default(true)
  isSelected  Boolean  @default(false) // New field for user selection
  description String?  // Model description
  metadata    String?  // Model-specific metadata as JSON string
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  provider    AIProvider @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@unique([providerId, modelId])
  @@map("ai_models")
}

model AppSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  category  String?  // 'general', 'ai', 'theme', etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("app_settings")
}

model Collection {
  id             String   @id @default(cuid())
  name           String   @unique
  description    String?
  chunkSize      Int      @default(1024)
  overlap        Int      @default(256)
  embeddingModel String
  modelProvider  String   // 'ollama' | 'openai' | 'anthropic' | etc.
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  documents Document[]

  @@map("collections")
}

model Document {
  id           String   @id @default(cuid())
  filename     String
  filepath     String?
  fileType     String   // 'pdf' | 'docx' | 'pptx' | 'xlsx'
  fileSize     Int
  content      String
  metadata     String?  // JSON as string - File-specific metadata
  collectionId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  collection Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  chunks     DocumentChunk[]

  @@map("documents")
}

model DocumentChunk {
  id         String   @id @default(cuid())
  documentId String
  content    String
  embedding  String?  // JSON as string
  metadata   String?  // JSON as string
  startPos   Int?
  endPos     Int?
  createdAt  DateTime @default(now())

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@map("document_chunks")
}

model AuthToken {
  id          String   @id @default(cuid())
  provider    String
  tokenType   String
  accessToken String
  refreshToken String?
  expiresAt   DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([provider, tokenType])
  @@map("auth_tokens")
}

model EmailMessage {
  id          String   @id @default(cuid())
  provider    String
  messageId   String
  subject     String
  from        String
  to          String   // JSON as string
  cc          String?  // JSON as string
  bcc         String?  // JSON as string
  body        String
  htmlBody    String?
  attachments String?  // JSON as string
  isRead      Boolean  @default(false)
  isImportant Boolean  @default(false)
  receivedAt  DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([provider, messageId])
  @@map("email_messages")
}

model CalendarEvent {
  id          String   @id @default(cuid())
  provider    String
  eventId     String
  title       String
  description String?
  location    String?
  startTime   DateTime
  endTime     DateTime
  isAllDay    Boolean  @default(false)
  attendees   String?  // JSON as string
  organizer   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([provider, eventId])
  @@map("calendar_events")
}

model UserProfile {
  id          String   @id @default(cuid())
  provider    String   // 'microsoft' | 'google'
  providerId  String   // User ID from provider
  email       String
  name        String?
  pictureUrl  String?
  isActive    Boolean  @default(true)
  metadata    String?  // Additional profile data as JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([provider, providerId])
  @@map("user_profiles")
}